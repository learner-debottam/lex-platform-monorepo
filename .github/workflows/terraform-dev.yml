name: Terraform Dev Pipeline

on:
  push:
    branches:
      - dev
      - main
  pull_request:
    branches:
      - dev
  workflow_dispatch:
    inputs:
      enable_tf_debug:
        description: "Enable Terraform debug logging (TF_LOG=DEBUG)"
        required: false
        type: boolean
        default: false

env:
  TF_WORKING_DIR: bot
  TF_CLI_ARGS_init: -input=false
  TF_CLI_ARGS_apply: -auto-approve -input=false
  TF_CLI_ARGS_plan: -input=false

jobs:
  lint:
    name: Lint, Format, Security, Schema Validation
    runs-on: ubuntu-latest

    steps:
      - name: Enable Terraform debug logging (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_tf_debug == 'true' }}
        run: echo "TF_LOG=DEBUG" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Terraform fmt (recursive)
        run: terraform fmt -check -recursive

      - name: Terraform validate (module)
        working-directory: modules/lexv2-bot
        run: |
          terraform init -backend=false
          terraform validate

      - name: Terraform validate (dev bot)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: |
          terraform init -backend=false
          terraform validate

      - name: Make validation script executable
        run: chmod +x bot/validate_bot_config.sh

      - name: Validate all bot config JSON files against schema
        run: |
          set -e
          shopt -s nullglob
          CONFIG_FILES=(bot/**/*.json bot/*.json)
          if [ ${#CONFIG_FILES[@]} -eq 0 ]; then
            echo "No bot config JSON files found under bot/. Skipping JSON validation."
            exit 0
          fi
          for cfg in "${CONFIG_FILES[@]}"; do
            # Skip schema or non-config JSONs explicitly if any
            if [[ "$cfg" == *"schema.json" ]]; then
              continue
            fi
            echo "Validating $cfg"
            ./bot/validate_bot_config.sh --config "$cfg"
          done

      - name: Run Checkov (Terraform security and compliance)
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: terraform
          quiet: true
          soft_fail: false

  plan:
    name: Terraform Plan (Dev)
    runs-on: ubuntu-latest
    needs: lint
    environment: dev

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Enable Terraform debug logging (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_tf_debug == 'true' }}
        run: echo "TF_LOG=DEBUG" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials (Dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE_DEV }}
          aws-region: ${{ secrets.AWS_REGION_DEV }}

      - name: Export Terraform variables for Dev
        run: |
          echo "TF_VAR_environment=dev" >> "$GITHUB_ENV"
          echo "TF_VAR_aws_region=${{ secrets.AWS_REGION_DEV }}" >> "$GITHUB_ENV"

          ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          echo "TF_VAR_aws_account_id=${ACCOUNT_ID}" >> "$GITHUB_ENV"

          # Optional: human-readable account name from secret
          echo "TF_VAR_aws_account_name=${{ secrets.AWS_ACCOUNT_NAME_DEV }}" >> "$GITHUB_ENV"

      - name: Make validation script executable
        run: chmod +x bot/validate_bot_config.sh

      - name: Validate bot config JSON before plan
        run: |
          set -e
          shopt -s nullglob
          CONFIG_FILES=(bot/**/*.json bot/*.json)
          if [ ${#CONFIG_FILES[@]} -eq 0 ]; then
            echo "No bot config JSON files found under bot/. Skipping JSON validation."
          else
            for cfg in "${CONFIG_FILES[@]}"; do
              if [[ "$cfg" == *"schema.json" ]]; then
                continue
              fi
              echo "Validating $cfg"
              ./bot/validate_bot_config.sh --config "$cfg"
            done
          fi

      - name: Terraform init (Dev)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform plan (Dev)
        id: plan
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform plan -out=tfplan-dev

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-dev
          path: ${{ env.TF_WORKING_DIR }}/tfplan-dev

  apply:
    name: Terraform Apply (Dev)
    runs-on: ubuntu-latest
    needs: plan
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    environment:
      name: dev
      url: https://console.aws.amazon.com/lexv2/home

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Enable Terraform debug logging (optional)
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.enable_tf_debug == 'true' }}
        run: echo "TF_LOG=DEBUG" >> "$GITHUB_ENV"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0

      - name: Configure AWS credentials (Dev)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ASSUME_ROLE_DEV }}
          aws-region: ${{ secrets.AWS_REGION_DEV }}

      - name: Export Terraform variables for Dev
        run: |
          echo "TF_VAR_environment=dev" >> "$GITHUB_ENV"
          echo "TF_VAR_aws_region=${{ secrets.AWS_REGION_DEV }}" >> "$GITHUB_ENV"

          ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
          echo "TF_VAR_aws_account_id=${ACCOUNT_ID}" >> "$GITHUB_ENV"

          echo "TF_VAR_aws_account_name=${{ secrets.AWS_ACCOUNT_NAME_DEV }}" >> "$GITHUB_ENV"

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: tfplan-dev
          path: ${{ env.TF_WORKING_DIR }}

      - name: Terraform init (Dev)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform init

      - name: Terraform apply (Dev)
        working-directory: ${{ env.TF_WORKING_DIR }}
        run: terraform apply tfplan-dev

